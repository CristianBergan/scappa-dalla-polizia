<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>City Runner Mobile & PC</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; overflow:hidden; background:#0f172a; font-family:sans-serif; touch-action:none;}
canvas { display:block; width:100vw; height:100vh; }
.ui-layer { position:absolute; inset:0; pointer-events:none; z-index:20; }
.clickable { pointer-events:auto; }
.level-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; }
.level-card {
  background: rgba(30,41,59,0.9);
  border: 2px solid rgba(255,255,255,0.05);
  aspect-ratio: 1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  border-radius:8px;
  cursor:pointer;
  transition:all 0.2s;
}
.level-card.unlocked:hover { background:#3b82f6; transform:translateY(-2px); }
.level-card.locked { opacity:0.3; cursor:not-allowed; }
#nitro-bar-container { width:200px; height:12px; background: rgba(0,0,0,0.5); border-radius:6px; overflow:hidden; border:1px solid rgba(255,255,255,0.2); }
#nitro-fill { width:100%; height:100%; background:linear-gradient(90deg,#3b82f6,#60a5fa); transition: width 0.1s; }

#joystick-container {
  position: absolute;
  bottom: 90px;
  left: 40px;
  width: 100px;
  height: 100px;
  background: rgba(255,255,255,0.1);
  border-radius:50%;
  touch-action:none;
  z-index:30;
}
#stick {
  position:absolute;
  left:50%; top:50%;
  width:50px; height:50px;
  background: rgba(59,130,246,0.7);
  border-radius:50%;
  transform: translate(-50%,-50%);
}

#boost-btn {
  position:absolute;
  bottom:80px;
  right:40px;
  width:70px;
  height:70px;
  border-radius:50%;
  background:#3b82f6;
  color:white;
  font-weight:bold;
  font-size:14px;
  text-align:center;
  line-height:70px;
  user-select:none;
  touch-action:none;
  z-index:30;
}

#level-menu { position:absolute; inset:0; z-index:50; background:#0f172a; display:flex; flex-direction:column; align-items:center; padding:20px; overflow-y:auto;}
#game-ui { display:none; position:absolute; inset:0; z-index:40; padding:10px; flex-direction:column; justify-content:space-between; pointer-events:none;}
#status-modal { position:absolute; inset:0; z-index:60; background: rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:white;}
</style>
</head>
<body>

<!-- Home Page -->
<div id="level-menu">
<h1 class="text-5xl font-black text-white mb-2 italic">CITY<span class="text-blue-500">RUNNER</span></h1>
<p class="text-slate-500 text-xs mb-10 uppercase tracking-[0.4em]">Evadi la polizia, raggiungi il garage</p>
<div class="level-grid w-full max-w-xl" id="grid-container"></div>
</div>

<!-- Game UI -->
<div id="game-ui" class="ui-layer flex flex-col justify-between p-4">
  <div class="flex justify-between items-start">
    <div class="bg-black/70 backdrop-blur p-3 rounded-xl border border-white/10 pointer-events-auto">
      <div class="text-[10px] text-slate-400 uppercase font-bold">Nitro</div>
      <div id="nitro-bar-container"><div id="nitro-fill"></div></div>
    </div>
    <div class="bg-black/70 backdrop-blur p-3 rounded-xl border border-white/10 pointer-events-auto">
      <div class="text-[10px] text-slate-400 uppercase font-bold">Distanza Garage</div>
      <div id="dist-to-garage" class="text-xl text-yellow-500 font-mono font-bold">0m</div>
    </div>
  </div>
</div>

<!-- Joystick & Boost -->
<div id="joystick-container"><div id="stick"></div></div>
<div id="boost-btn">BOOST</div>

<!-- Modal -->
<div id="status-modal">
<h2 id="status-title" class="text-7xl font-black italic mb-2"></h2>
<p id="status-desc" class="text-slate-400 mb-10 text-xl font-light"></p>
<button onclick="exitToMenu()" class="clickable px-12 py-5 bg-white text-black font-black rounded-full uppercase text-sm tracking-widest hover:scale-105 transition-transform">Continua</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let width,height;
function resize(){width=canvas.width=window.innerWidth;height=canvas.height=window.innerHeight;}
window.addEventListener('resize',resize);
resize();

const gridContainer=document.getElementById('grid-container');
let currentLevel=1;
let unlockedLevel=parseInt(localStorage.getItem('city_escape_unlocked'))||1;
const WORLD_SIZE=3000;
let enemies=[],civilians=[],particles=[];
let garage={x:0,y:0,w:140,h:140};
let gameActive=false;

const keys={left:false,right:false,up:false,nitro:false};

class Player{
  constructor(){this.reset();}
  reset(){this.x=0;this.y=0;this.angle=0;this.speed=0;this.maxNormalSpeed=7;this.maxNitroSpeed=13;this.nitro=100;}
  update(){
    const isUsingNitro=keys.nitro && keys.up && this.nitro>0;
    const topSpeed=isUsingNitro?this.maxNitroSpeed:this.maxNormalSpeed;
    if(keys.up){this.speed=Math.min(this.speed+0.15,topSpeed); if(isUsingNitro)this.nitro-=0.5; else if(this.nitro<100)this.nitro+=0.1;} else this.speed*=0.97;if(this.nitro<100&&!isUsingNitro)this.nitro+=0.1;
    if(keys.left)this.angle-=0.05*(this.speed/5+0.5);
    if(keys.right)this.angle+=0.05*(this.speed/5+0.5);
    this.x+=Math.cos(this.angle)*this.speed;
    this.y+=Math.sin(this.angle)*this.speed;
    document.getElementById('nitro-fill').style.width=this.nitro+'%';
  }
  draw(){
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.angle);
    ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.fillRect(-22,-12,44,24);
    ctx.fillStyle='#1d4ed8'; ctx.fillRect(-20,-10,40,20);
    ctx.fillStyle='#60a5fa'; ctx.fillRect(-5,-8,15,16);
    if(keys.up){ctx.fillStyle=keys.nitro?'#60a5fa':'#ef4444';ctx.fillRect(-22,-9,4,6);ctx.fillRect(-22,3,4,6);}
    ctx.restore();
  }
}

class Agent{
  constructor(type,isCivilian=false){this.type=type;this.isCivilian=isCivilian;this.resetPos();this.angle=Math.random()*Math.PI*2;this.speed=isCivilian?2+Math.random()*2:4+Math.random()*2;this.color=isCivilian?'#94a3b8':'#fff';this.stunTime=0;}
  resetPos(){const dist=1000+Math.random()*1000;const a=Math.random()*Math.PI*2;this.x=Math.cos(a)*dist;this.y=Math.sin(a)*dist;}
  update(target){
    if(this.stunTime>0){this.stunTime--;return;}
    if(this.isCivilian){if(Math.random()<0.01)this.angle+=(Math.random()-0.5);} 
    else {const targetAngle=Math.atan2(target.y-this.y,target.x-this.x);let diff=targetAngle-this.angle;while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;this.angle+=diff*0.04;}
    this.x+=Math.cos(this.angle)*this.speed;
    this.y+=Math.sin(this.angle)*this.speed;
    const d=Math.hypot(this.x-target.x,this.y-target.y);
    if(d<35){if(this.isCivilian){this.stunTime=100;target.stunTime=30;createParticles(this.x,this.y,'#fff',10);} else endGame(false);}
  }
  draw(){
    ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);
    if(this.type==='heli'){ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(0,0,20,0,Math.PI*2);ctx.fill();ctx.fillRect(-40,-2,80,4);}
    else if(this.type==='tank'){ctx.fillStyle='#365314';ctx.fillRect(-30,-20,60,40);ctx.fillStyle='#1a2e05';ctx.fillRect(0,-5,45,10);}
    else {ctx.fillStyle=this.color;ctx.fillRect(-18,-9,36,18);
      if(!this.isCivilian&&Date.now()%400<200){ctx.fillStyle='#ef4444';ctx.fillRect(2,-9,8,4);ctx.fillStyle='#3b82f6';ctx.fillRect(2,5,8,4);}}
    ctx.restore();
  }
}

function createParticles(x,y,color,count){for(let i=0;i<count;i++)particles.push({x,y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:1,color});}

const player=new Player();

function startLevel(lvl){
  currentLevel=lvl;
  document.getElementById('leve

